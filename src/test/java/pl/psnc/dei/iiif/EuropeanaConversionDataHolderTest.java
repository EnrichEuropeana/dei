package pl.psnc.dei.iiif;

import org.apache.jena.atlas.json.JSON;
import org.apache.jena.atlas.json.JsonObject;
import org.apache.jena.atlas.json.JsonValue;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;
import org.mockito.Mockito;

import java.util.Optional;

import static pl.psnc.dei.iiif.EuropeanaConversionDataHolder.EDM_IS_SHOWN_BY;
import static pl.psnc.dei.iiif.EuropeanaConversionDataHolder.KEY_ID;

public class EuropeanaConversionDataHolderTest {

	private static final String RECORD_FULL_JSON = "{\"@context\":{\"rdf\":\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\",\"dc\":\"http://purl.org/dc/elements/1.1/\",\"dcterms\":\"http://purl.org/dc/terms/\",\"edm\":\"http://www.europeana.eu/schemas/edm/\",\"owl\":\"http://www.w3.org/2002/07/owl#\",\"wgs84_pos\":\"http://www.w3.org/2003/01/geo/wgs84_pos#\",\"skos\":\"http://www.w3.org/2004/02/skos/core#\",\"rdaGr2\":\"http://rdvocab.info/ElementsGr2/\",\"foaf\":\"http://xmlns.com/foaf/0.1/\",\"ebucore\":\"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#\",\"doap\":\"http://usefulinc.com/ns/doap#\",\"odrl\":\"http://www.w3.org/ns/odrl/2/\",\"cc\":\"http://creativecommons.org/ns#\",\"ore\":\"http://www.openarchives.org/ore/terms/\",\"svcs\":\"http://rdfs.org/sioc/services#\",\"oa\":\"http://www.w3.org/ns/oa#\",\"dqv\":\"http://www.w3.org/ns/dqv#\"},\"@graph\":[{\"@id\":\"#conceptOf:nnVvzs0_1\",\"@type\":\"skos:Concept\",\"skos:prefLabel\":\"gyvoji grandinė\"},{\"@id\":\"#conceptOf:nnVvzs0_2\",\"@type\":\"skos:Concept\",\"skos:prefLabel\":\"Batijos kelias\"},{\"@id\":\"#conceptOf:nnVvzs0_3\",\"@type\":\"skos:Concept\",\"skos:prefLabel\":\"the Baltic Way\"},{\"@id\":\"#conceptOf:nnVvzs0_4\",\"@type\":\"skos:Concept\",\"skos:prefLabel\":\"image/jpeg\"},{\"@id\":\"#placeOf:nnVvzs0_1\",\"@type\":\"edm:Place\",\"wgs84_pos:lat\":\"54.81012\",\"wgs84_pos:long\":\"25.27244\"},{\"@id\":\"#timeSpanOf:nnVvzs0_1\",\"@type\":\"edm:TimeSpan\",\"skos:prefLabel\":\"1989-8-23\"},{\"@id\":\"http://data.europeana.eu/aggregation/europeana/2025903/_nnVvzs0\",\"@type\":\"edm:EuropeanaAggregation\",\"dcterms:created\":\"2019-09-17T15:02:03.980Z\",\"dcterms:modified\":\"2019-09-17T15:02:03.980Z\",\"edm:aggregatedCHO\":{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\"},\"edm:completeness\":\"8\",\"edm:country\":\"Lithuania\",\"edm:datasetName\":\"2025903_Ag_EU_1989_Lithuania\",\"edm:landingPage\":{\"@id\":\"https://www.europeana.eu/portal/record/2025903/_nnVvzs0.html\"},\"edm:language\":\"lt\",\"edm:preview\":{\"@id\":\"http://fbc.pionier.net.pl/zbiorki/Content/522/VIL152.jpg\"},\"dqv:hasQualityAnnotation\":[{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0#metadataTier\"},{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0#contentTier\"}]},{\"@id\":\"http://data.europeana.eu/aggregation/provider/2025903/_nnVvzs0\",\"@type\":\"ore:Aggregation\",\"edm:aggregatedCHO\":{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\"},\"edm:dataProvider\":\"Europeana 1989\",\"edm:isShownAt\":{\"@id\":\"http://fbc.pionier.net.pl/id/oai:europeana1989.eu:522\"},\"edm:isShownBy\":{\"@id\":\"http://fbc.pionier.net.pl/zbiorki/Content/522/VIL152.jpg\"},\"edm:object\":{\"@id\":\"http://fbc.pionier.net.pl/zbiorki/Content/522/VIL152.jpg\"},\"edm:provider\":\"Europeana 1989\",\"edm:rights\":{\"@id\":\"http://creativecommons.org/licenses/by-sa/3.0/pl/\"},\"edm:ugc\":\"true\"},{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\",\"@type\":\"edm:ProvidedCHO\"},{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0#contentTier\",\"@type\":\"dqv:QualityAnnotation\",\"dcterms:created\":\"2019-09-17T15:02:03.949Z\",\"oa:hasBody\":{\"@id\":\"http://www.europeana.eu/schemas/epf/contentTier4\"},\"oa:hasTarget\":{\"@id\":\"http://data.europeana.eu/aggregation/provider/2025903/_nnVvzs0\"}},{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0#metadataTier\",\"@type\":\"dqv:QualityAnnotation\",\"dcterms:created\":\"2019-09-17T15:02:03.950Z\",\"oa:hasBody\":{\"@id\":\"http://www.europeana.eu/schemas/epf/metadataTierA\"},\"oa:hasTarget\":{\"@id\":\"http://data.europeana.eu/aggregation/provider/2025903/_nnVvzs0\"}},{\"@id\":\"http://data.europeana.eu/proxy/europeana/2025903/_nnVvzs0\",\"@type\":\"ore:Proxy\",\"dc:identifier\":\"#nnVvzs0\",\"edm:europeanaProxy\":\"true\",\"edm:type\":\"IMAGE\",\"ore:proxyFor\":{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\"},\"ore:proxyIn\":{\"@id\":\"http://data.europeana.eu/aggregation/europeana/2025903/_nnVvzs0\"}},{\"@id\":\"http://data.europeana.eu/proxy/provider/2025903/_nnVvzs0\",\"@type\":\"ore:Proxy\",\"dc:description\":[{\"@language\":\"lt\",\"@value\":\"Europeana 1989 - Vilnius, 9-10.08.2013\"},{\"@language\":\"lt\",\"@value\":\"Nuotraukoje D. Stabrauskienė su šeima ir vyro bendradarbiais stovi Baltijos kelio grandinėje Molėtų plento 14–15 km.\"}],\"dc:format\":\"#conceptOf:nnVvzs0_4\",\"dc:identifier\":\"VIL152\",\"dc:rights\":{\"@id\":\"http://creativecommons.org/licenses/by-sa/3.0/pl/ Kūrybinių bendrijų licencija Creative Commons Attribution-Share Alike (CC-BY-SA)\"},\"dc:subject\":[{\"@language\":\"lt\",\"@value\":\"#conceptOf:nnVvzs0_3\"},{\"@language\":\"lt\",\"@value\":\"#conceptOf:nnVvzs0_1\"},{\"@language\":\"lt\",\"@value\":\"#conceptOf:nnVvzs0_2\"}],\"dc:title\":{\"@language\":\"lt\",\"@value\":\"Baltijos kelio dalyvių nuotrauka\"},\"dc:type\":[{\"@language\":\"lt\",\"@value\":\"nuotrauka\"},{\"@language\":\"lt\",\"@value\":\"fotografia\"}],\"dcterms:isPartOf\":\"Europeana 1989 - Vilnius, 9-10.08.2013\",\"dcterms:provenance\":{\"@language\":\"en\",\"@value\":\"Lithuania\"},\"dcterms:spatial\":{\"@language\":\"lt\",\"@value\":\"#placeOf:nnVvzs0_1\"},\"dcterms:temporal\":{\"@language\":\"lt\",\"@value\":\"#timeSpanOf:nnVvzs0_1\"},\"edm:currentLocation\":\"#locationOf:nnVvzs0\",\"edm:europeanaProxy\":\"false\",\"edm:type\":\"IMAGE\",\"ore:proxyFor\":{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\"},\"ore:proxyIn\":{\"@id\":\"http://data.europeana.eu/aggregation/provider/2025903/_nnVvzs0\"}},{\"@id\":\"http://fbc.pionier.net.pl/id/oai:europeana1989.eu:522\",\"@type\":\"edm:WebResource\",\"ebucore:fileByteSize\":{\"@type\":\"http://www.w3.org/2001/XMLSchema#long\",\"@value\":\"59299\"},\"ebucore:hasMimeType\":\"application/xhtml+xml\"},{\"@id\":\"http://fbc.pionier.net.pl/zbiorki/Content/522/VIL152.jpg\",\"@type\":\"edm:WebResource\",\"ebucore:fileByteSize\":{\"@type\":\"http://www.w3.org/2001/XMLSchema#long\",\"@value\":\"254426\"},\"ebucore:hasMimeType\":\"image/jpeg\",\"ebucore:height\":1051,\"ebucore:orientation\":\"landscape\",\"ebucore:width\":1574,\"edm:componentColor\":[{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#8B4513\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#696969\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#800000\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#D2B48C\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#A0522D\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#2F4F4F\"}],\"edm:hasColorSpace\":\"sRGB\",\"edm:rights\":{\"@id\":\"http://creativecommons.org/licenses/by-sa/3.0/pl/\"}}]}";
	private static final String RECORD_MISSING_MIME_TYPE_JSON = "{\"@context\":{\"rdf\":\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\",\"dc\":\"http://purl.org/dc/elements/1.1/\",\"dcterms\":\"http://purl.org/dc/terms/\",\"edm\":\"http://www.europeana.eu/schemas/edm/\",\"owl\":\"http://www.w3.org/2002/07/owl#\",\"wgs84_pos\":\"http://www.w3.org/2003/01/geo/wgs84_pos#\",\"skos\":\"http://www.w3.org/2004/02/skos/core#\",\"rdaGr2\":\"http://rdvocab.info/ElementsGr2/\",\"foaf\":\"http://xmlns.com/foaf/0.1/\",\"ebucore\":\"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#\",\"doap\":\"http://usefulinc.com/ns/doap#\",\"odrl\":\"http://www.w3.org/ns/odrl/2/\",\"cc\":\"http://creativecommons.org/ns#\",\"ore\":\"http://www.openarchives.org/ore/terms/\",\"svcs\":\"http://rdfs.org/sioc/services#\",\"oa\":\"http://www.w3.org/ns/oa#\",\"dqv\":\"http://www.w3.org/ns/dqv#\"},\"@graph\":[{\"@id\":\"#conceptOf:nnVvzs0_1\",\"@type\":\"skos:Concept\",\"skos:prefLabel\":\"gyvoji grandinė\"},{\"@id\":\"#conceptOf:nnVvzs0_2\",\"@type\":\"skos:Concept\",\"skos:prefLabel\":\"Batijos kelias\"},{\"@id\":\"#conceptOf:nnVvzs0_3\",\"@type\":\"skos:Concept\",\"skos:prefLabel\":\"the Baltic Way\"},{\"@id\":\"#conceptOf:nnVvzs0_4\",\"@type\":\"skos:Concept\",\"skos:prefLabel\":\"image/jpeg\"},{\"@id\":\"#placeOf:nnVvzs0_1\",\"@type\":\"edm:Place\",\"wgs84_pos:lat\":\"54.81012\",\"wgs84_pos:long\":\"25.27244\"},{\"@id\":\"#timeSpanOf:nnVvzs0_1\",\"@type\":\"edm:TimeSpan\",\"skos:prefLabel\":\"1989-8-23\"},{\"@id\":\"http://data.europeana.eu/aggregation/europeana/2025903/_nnVvzs0\",\"@type\":\"edm:EuropeanaAggregation\",\"dcterms:created\":\"2019-09-17T15:02:03.980Z\",\"dcterms:modified\":\"2019-09-17T15:02:03.980Z\",\"edm:aggregatedCHO\":{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\"},\"edm:completeness\":\"8\",\"edm:country\":\"Lithuania\",\"edm:datasetName\":\"2025903_Ag_EU_1989_Lithuania\",\"edm:landingPage\":{\"@id\":\"https://www.europeana.eu/portal/record/2025903/_nnVvzs0.html\"},\"edm:language\":\"lt\",\"edm:preview\":{\"@id\":\"http://fbc.pionier.net.pl/zbiorki/Content/522/VIL152.jpg\"},\"dqv:hasQualityAnnotation\":[{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0#metadataTier\"},{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0#contentTier\"}]},{\"@id\":\"http://data.europeana.eu/aggregation/provider/2025903/_nnVvzs0\",\"@type\":\"ore:Aggregation\",\"edm:aggregatedCHO\":{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\"},\"edm:dataProvider\":\"Europeana 1989\",\"edm:isShownAt\":{\"@id\":\"http://fbc.pionier.net.pl/id/oai:europeana1989.eu:522\"},\"edm:isShownBy\":{\"@id\":\"http://fbc.pionier.net.pl/zbiorki/Content/522/VIL152.jpg\"},\"edm:object\":{\"@id\":\"http://fbc.pionier.net.pl/zbiorki/Content/522/VIL152.jpg\"},\"edm:provider\":\"Europeana 1989\",\"edm:rights\":{\"@id\":\"http://creativecommons.org/licenses/by-sa/3.0/pl/\"},\"edm:ugc\":\"true\"},{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\",\"@type\":\"edm:ProvidedCHO\"},{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0#contentTier\",\"@type\":\"dqv:QualityAnnotation\",\"dcterms:created\":\"2019-09-17T15:02:03.949Z\",\"oa:hasBody\":{\"@id\":\"http://www.europeana.eu/schemas/epf/contentTier4\"},\"oa:hasTarget\":{\"@id\":\"http://data.europeana.eu/aggregation/provider/2025903/_nnVvzs0\"}},{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0#metadataTier\",\"@type\":\"dqv:QualityAnnotation\",\"dcterms:created\":\"2019-09-17T15:02:03.950Z\",\"oa:hasBody\":{\"@id\":\"http://www.europeana.eu/schemas/epf/metadataTierA\"},\"oa:hasTarget\":{\"@id\":\"http://data.europeana.eu/aggregation/provider/2025903/_nnVvzs0\"}},{\"@id\":\"http://data.europeana.eu/proxy/europeana/2025903/_nnVvzs0\",\"@type\":\"ore:Proxy\",\"dc:identifier\":\"#nnVvzs0\",\"edm:europeanaProxy\":\"true\",\"edm:type\":\"IMAGE\",\"ore:proxyFor\":{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\"},\"ore:proxyIn\":{\"@id\":\"http://data.europeana.eu/aggregation/europeana/2025903/_nnVvzs0\"}},{\"@id\":\"http://data.europeana.eu/proxy/provider/2025903/_nnVvzs0\",\"@type\":\"ore:Proxy\",\"dc:description\":[{\"@language\":\"lt\",\"@value\":\"Europeana 1989 - Vilnius, 9-10.08.2013\"},{\"@language\":\"lt\",\"@value\":\"Nuotraukoje D. Stabrauskienė su šeima ir vyro bendradarbiais stovi Baltijos kelio grandinėje Molėtų plento 14–15 km.\"}],\"dc:format\":\"#conceptOf:nnVvzs0_4\",\"dc:identifier\":\"VIL152\",\"dc:rights\":{\"@id\":\"http://creativecommons.org/licenses/by-sa/3.0/pl/ Kūrybinių bendrijų licencija Creative Commons Attribution-Share Alike (CC-BY-SA)\"},\"dc:subject\":[{\"@language\":\"lt\",\"@value\":\"#conceptOf:nnVvzs0_3\"},{\"@language\":\"lt\",\"@value\":\"#conceptOf:nnVvzs0_1\"},{\"@language\":\"lt\",\"@value\":\"#conceptOf:nnVvzs0_2\"}],\"dc:title\":{\"@language\":\"lt\",\"@value\":\"Baltijos kelio dalyvių nuotrauka\"},\"dc:type\":[{\"@language\":\"lt\",\"@value\":\"nuotrauka\"},{\"@language\":\"lt\",\"@value\":\"fotografia\"}],\"dcterms:isPartOf\":\"Europeana 1989 - Vilnius, 9-10.08.2013\",\"dcterms:provenance\":{\"@language\":\"en\",\"@value\":\"Lithuania\"},\"dcterms:spatial\":{\"@language\":\"lt\",\"@value\":\"#placeOf:nnVvzs0_1\"},\"dcterms:temporal\":{\"@language\":\"lt\",\"@value\":\"#timeSpanOf:nnVvzs0_1\"},\"edm:currentLocation\":\"#locationOf:nnVvzs0\",\"edm:europeanaProxy\":\"false\",\"edm:type\":\"IMAGE\",\"ore:proxyFor\":{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\"},\"ore:proxyIn\":{\"@id\":\"http://data.europeana.eu/aggregation/provider/2025903/_nnVvzs0\"}},{\"@id\":\"http://fbc.pionier.net.pl/id/oai:europeana1989.eu:522\",\"@type\":\"edm:WebResource\",\"ebucore:fileByteSize\":{\"@type\":\"http://www.w3.org/2001/XMLSchema#long\",\"@value\":\"59299\"},\"ebucore:hasMimeType\":\"application/xhtml+xml\"},{\"@id\":\"http://fbc.pionier.net.pl/zbiorki/Content/522/VIL152.jpg\",\"@type\":\"edm:WebResource\",\"ebucore:fileByteSize\":{\"@type\":\"http://www.w3.org/2001/XMLSchema#long\",\"@value\":\"254426\"},\"ebucore:height\":1051,\"ebucore:orientation\":\"landscape\",\"ebucore:width\":1574,\"edm:componentColor\":[{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#8B4513\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#696969\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#800000\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#D2B48C\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#A0522D\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#2F4F4F\"}],\"edm:hasColorSpace\":\"sRGB\",\"edm:rights\":{\"@id\":\"http://creativecommons.org/licenses/by-sa/3.0/pl/\"}}]}";
	private static final String RECORD_MISSING_MIME_TYPE_NO_EXTENSION_JSON = "{\"@context\":{\"rdf\":\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\",\"dc\":\"http://purl.org/dc/elements/1.1/\",\"dcterms\":\"http://purl.org/dc/terms/\",\"edm\":\"http://www.europeana.eu/schemas/edm/\",\"owl\":\"http://www.w3.org/2002/07/owl#\",\"wgs84_pos\":\"http://www.w3.org/2003/01/geo/wgs84_pos#\",\"skos\":\"http://www.w3.org/2004/02/skos/core#\",\"rdaGr2\":\"http://rdvocab.info/ElementsGr2/\",\"foaf\":\"http://xmlns.com/foaf/0.1/\",\"ebucore\":\"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#\",\"doap\":\"http://usefulinc.com/ns/doap#\",\"odrl\":\"http://www.w3.org/ns/odrl/2/\",\"cc\":\"http://creativecommons.org/ns#\",\"ore\":\"http://www.openarchives.org/ore/terms/\",\"svcs\":\"http://rdfs.org/sioc/services#\",\"oa\":\"http://www.w3.org/ns/oa#\",\"dqv\":\"http://www.w3.org/ns/dqv#\"},\"@graph\":[{\"@id\":\"#conceptOf:nnVvzs0_1\",\"@type\":\"skos:Concept\",\"skos:prefLabel\":\"gyvoji grandinė\"},{\"@id\":\"#conceptOf:nnVvzs0_2\",\"@type\":\"skos:Concept\",\"skos:prefLabel\":\"Batijos kelias\"},{\"@id\":\"#conceptOf:nnVvzs0_3\",\"@type\":\"skos:Concept\",\"skos:prefLabel\":\"the Baltic Way\"},{\"@id\":\"#conceptOf:nnVvzs0_4\",\"@type\":\"skos:Concept\",\"skos:prefLabel\":\"image/jpeg\"},{\"@id\":\"#placeOf:nnVvzs0_1\",\"@type\":\"edm:Place\",\"wgs84_pos:lat\":\"54.81012\",\"wgs84_pos:long\":\"25.27244\"},{\"@id\":\"#timeSpanOf:nnVvzs0_1\",\"@type\":\"edm:TimeSpan\",\"skos:prefLabel\":\"1989-8-23\"},{\"@id\":\"http://data.europeana.eu/aggregation/europeana/2025903/_nnVvzs0\",\"@type\":\"edm:EuropeanaAggregation\",\"dcterms:created\":\"2019-09-17T15:02:03.980Z\",\"dcterms:modified\":\"2019-09-17T15:02:03.980Z\",\"edm:aggregatedCHO\":{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\"},\"edm:completeness\":\"8\",\"edm:country\":\"Lithuania\",\"edm:datasetName\":\"2025903_Ag_EU_1989_Lithuania\",\"edm:landingPage\":{\"@id\":\"https://www.europeana.eu/portal/record/2025903/_nnVvzs0.html\"},\"edm:language\":\"lt\",\"edm:preview\":{\"@id\":\"http://fbc.pionier.net.pl/zbiorki/Content/522/VIL152\"},\"dqv:hasQualityAnnotation\":[{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0#metadataTier\"},{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0#contentTier\"}]},{\"@id\":\"http://data.europeana.eu/aggregation/provider/2025903/_nnVvzs0\",\"@type\":\"ore:Aggregation\",\"edm:aggregatedCHO\":{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\"},\"edm:dataProvider\":\"Europeana 1989\",\"edm:isShownAt\":{\"@id\":\"http://fbc.pionier.net.pl/id/oai:europeana1989.eu:522\"},\"edm:isShownBy\":{\"@id\":\"http://fbc.pionier.net.pl/zbiorki/Content/522/VIL152\"},\"edm:object\":{\"@id\":\"http://fbc.pionier.net.pl/zbiorki/Content/522/VIL152\"},\"edm:provider\":\"Europeana 1989\",\"edm:rights\":{\"@id\":\"http://creativecommons.org/licenses/by-sa/3.0/pl/\"},\"edm:ugc\":\"true\"},{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\",\"@type\":\"edm:ProvidedCHO\"},{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0#contentTier\",\"@type\":\"dqv:QualityAnnotation\",\"dcterms:created\":\"2019-09-17T15:02:03.949Z\",\"oa:hasBody\":{\"@id\":\"http://www.europeana.eu/schemas/epf/contentTier4\"},\"oa:hasTarget\":{\"@id\":\"http://data.europeana.eu/aggregation/provider/2025903/_nnVvzs0\"}},{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0#metadataTier\",\"@type\":\"dqv:QualityAnnotation\",\"dcterms:created\":\"2019-09-17T15:02:03.950Z\",\"oa:hasBody\":{\"@id\":\"http://www.europeana.eu/schemas/epf/metadataTierA\"},\"oa:hasTarget\":{\"@id\":\"http://data.europeana.eu/aggregation/provider/2025903/_nnVvzs0\"}},{\"@id\":\"http://data.europeana.eu/proxy/europeana/2025903/_nnVvzs0\",\"@type\":\"ore:Proxy\",\"dc:identifier\":\"#nnVvzs0\",\"edm:europeanaProxy\":\"true\",\"edm:type\":\"IMAGE\",\"ore:proxyFor\":{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\"},\"ore:proxyIn\":{\"@id\":\"http://data.europeana.eu/aggregation/europeana/2025903/_nnVvzs0\"}},{\"@id\":\"http://data.europeana.eu/proxy/provider/2025903/_nnVvzs0\",\"@type\":\"ore:Proxy\",\"dc:description\":[{\"@language\":\"lt\",\"@value\":\"Europeana 1989 - Vilnius, 9-10.08.2013\"},{\"@language\":\"lt\",\"@value\":\"Nuotraukoje D. Stabrauskienė su šeima ir vyro bendradarbiais stovi Baltijos kelio grandinėje Molėtų plento 14–15 km.\"}],\"dc:format\":\"#conceptOf:nnVvzs0_4\",\"dc:identifier\":\"VIL152\",\"dc:rights\":{\"@id\":\"http://creativecommons.org/licenses/by-sa/3.0/pl/ Kūrybinių bendrijų licencija Creative Commons Attribution-Share Alike (CC-BY-SA)\"},\"dc:subject\":[{\"@language\":\"lt\",\"@value\":\"#conceptOf:nnVvzs0_3\"},{\"@language\":\"lt\",\"@value\":\"#conceptOf:nnVvzs0_1\"},{\"@language\":\"lt\",\"@value\":\"#conceptOf:nnVvzs0_2\"}],\"dc:title\":{\"@language\":\"lt\",\"@value\":\"Baltijos kelio dalyvių nuotrauka\"},\"dc:type\":[{\"@language\":\"lt\",\"@value\":\"nuotrauka\"},{\"@language\":\"lt\",\"@value\":\"fotografia\"}],\"dcterms:isPartOf\":\"Europeana 1989 - Vilnius, 9-10.08.2013\",\"dcterms:provenance\":{\"@language\":\"en\",\"@value\":\"Lithuania\"},\"dcterms:spatial\":{\"@language\":\"lt\",\"@value\":\"#placeOf:nnVvzs0_1\"},\"dcterms:temporal\":{\"@language\":\"lt\",\"@value\":\"#timeSpanOf:nnVvzs0_1\"},\"edm:currentLocation\":\"#locationOf:nnVvzs0\",\"edm:europeanaProxy\":\"false\",\"edm:type\":\"IMAGE\",\"ore:proxyFor\":{\"@id\":\"http://data.europeana.eu/item/2025903/_nnVvzs0\"},\"ore:proxyIn\":{\"@id\":\"http://data.europeana.eu/aggregation/provider/2025903/_nnVvzs0\"}},{\"@id\":\"http://fbc.pionier.net.pl/id/oai:europeana1989.eu:522\",\"@type\":\"edm:WebResource\",\"ebucore:fileByteSize\":{\"@type\":\"http://www.w3.org/2001/XMLSchema#long\",\"@value\":\"59299\"},\"ebucore:hasMimeType\":\"application/xhtml+xml\"},{\"@id\":\"http://fbc.pionier.net.pl/zbiorki/Content/522/VIL152\",\"@type\":\"edm:WebResource\",\"ebucore:fileByteSize\":{\"@type\":\"http://www.w3.org/2001/XMLSchema#long\",\"@value\":\"254426\"},\"ebucore:height\":1051,\"ebucore:orientation\":\"landscape\",\"ebucore:width\":1574,\"edm:componentColor\":[{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#8B4513\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#696969\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#800000\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#D2B48C\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#A0522D\"},{\"@type\":\"http://www.w3.org/2001/XMLSchema#hexBinary\",\"@value\":\"#2F4F4F\"}],\"edm:hasColorSpace\":\"sRGB\",\"edm:rights\":{\"@id\":\"http://creativecommons.org/licenses/by-sa/3.0/pl/\"}}]}";

	private EuropeanaConversionDataHolder holder;

	@Before
	public void init() {
		holder = Mockito.mock(EuropeanaConversionDataHolder.class);
		Mockito.when(holder.detectType(Mockito.anyString(), Mockito.any(JsonObject.class))).thenCallRealMethod();
	}

	@Test
	public void extractExistingMimeType() {
		JsonObject recordJson = JSON.parse(RECORD_FULL_JSON);
		Optional<JsonObject> aggregatorData = getAggregatorData(recordJson);

		if (aggregatorData.isPresent()) {
			JsonObject isShownBy = aggregatorData.get().get(EDM_IS_SHOWN_BY).getAsObject();

			String mediaType = holder.detectType(isShownBy.getAsObject().get(KEY_ID).getAsString().value(), recordJson);

			Assert.assertEquals("jpeg", mediaType);
		}
	}


	@Test
	public void extractMissingMimeType() {
		JsonObject recordJson = JSON.parse(RECORD_MISSING_MIME_TYPE_JSON);
		Optional<JsonObject> aggregatorData = getAggregatorData(recordJson);

		if (aggregatorData.isPresent()) {
			JsonObject isShownBy = aggregatorData.get().get(EDM_IS_SHOWN_BY).getAsObject();
			String resourceId = isShownBy.getAsObject().get(KEY_ID).getAsString().value();
			String mediaType = holder.detectType(resourceId, recordJson);

			Assert.assertEquals("jpg", mediaType);
			Assert.assertTrue(resourceId.endsWith(mediaType));
		}
	}


	@Test
	public void extractMissingMimeTypeNoExtension() {
		JsonObject recordJson = JSON.parse(RECORD_MISSING_MIME_TYPE_NO_EXTENSION_JSON);

		Optional<JsonObject> aggregatorData = getAggregatorData(recordJson);

		if (aggregatorData.isPresent()) {
			JsonObject isShownBy = aggregatorData.get().get(EDM_IS_SHOWN_BY).getAsObject();
			String resourceId = isShownBy.getAsObject().get(KEY_ID).getAsString().value();
			String mediaType = holder.detectType(resourceId, recordJson);

			Assert.assertNull(mediaType);
		}
	}

	private Optional<JsonObject> getAggregatorData(JsonObject recordJson) {
		return recordJson.get("@graph").getAsArray().stream()
				.map(JsonValue::getAsObject)
				.filter(e -> e.get("edm:isShownBy") != null)
				.findFirst();
	}
}