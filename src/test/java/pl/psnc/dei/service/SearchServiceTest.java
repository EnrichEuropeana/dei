package pl.psnc.dei.service;

import org.junit.Assert;
import org.junit.FixMethodOrder;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.junit.runners.MethodSorters;
import org.mockito.ArgumentMatchers;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.reactive.AutoConfigureWebTestClient;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.test.context.TestPropertySource;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.web.reactive.server.WebTestClient;
import org.springframework.web.reactive.function.client.ClientResponse;
import org.springframework.web.reactive.function.client.WebClient;
import pl.psnc.dei.exception.DEIHttpException;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.function.Function;
import java.util.function.Predicate;

import static org.mockito.ArgumentMatchers.notNull;
import static org.mockito.Mockito.when;

@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
public class SearchServiceTest {

    private static final String RESPONSE_OK = "{\"apikey\":\"api2demo\",\"success\":true,\"requestNumber\":999,\"itemsCount\":12,\"totalResults\":119519,\"items\":[{\"id\":\"/2048017/Athena_Plus_ProvidedCHO_Pictures_bank_eu__ICIMSS__61725\",\"ugc\":[false],\"country\":[\"Poland\"],\"europeanaCollectionName\":[\"2048017_Ag_EU_AthenaPlus_ICIMSS\"],\"edmPlaceAltLabelLangAware\":{\"def\":[\"Wielkopolskie\",\"Województwo Wielkopolskie\",\"Poznań\",\"Lengyelország\",\"Lenkija\",\"PL\",\"Poland\",\"Polen\",\"Polija\",\"Polish People’s Republic\",\"Pologne\",\"Polonia\",\"Polsha\",\"Polska\",\"Polska Rzeczpospolita Ludowa\",\"Polsko\",\"Poola\"]},\"dcDescriptionLangAware\":{\"pl\":[\"[PL]: Neorenesansowa kamienica przy ul. Jana Henryka Dąbrowskiego 49 w Poznaniu.                                        ...(Pełen opis dostępny na stronie www.pictures-bank.eu). Autorem zdjęcia jest Piotr Kożurno\"]},\"dcSubjectLangAware\":{\"en\":[\"Poland\",\"Greater Poland\",\"Great Poland\",\"Wielkopolska\",\"Poznań\",\"49 Dąbrowskiego St\",\"tenement house\",\"tenement houses\",\"Neo-Renaissance\",\"Renaissance Revival\",\"Neo-Renaissance architecture\",\"Renaissance Revival architecture\",\"Revival architectural styles\",\"Housing architecture\"],\"pl\":[\"Polska\",\"Wielkopolska\",\"Poznań\",\"Jeżyce\",\"ul. Jana Henryka Dąbrowskiego 49\",\"ul. Dąbrowskiego 49\",\"kamienica\",\"kamienice\",\"neorenesans\",\"architektura neorenesansu\",\"Neostyle w architekturze\",\"Budynki mieszkalne\"]},\"dcTypeLangAware\":{\"en\":[\"Photography\"],\"pl\":[\"Zdjęcie cyfrowe\"]},\"edmIsShownBy\":[\"http://www.pictures-bank.eu/pokazobrazek.php?fileno=61725&a=1\"],\"dcDescription\":[\"[PL]: Neorenesansowa kamienica przy ul. Jana Henryka Dąbrowskiego 49 w Poznaniu.                                        ...(Pełen opis dostępny na stronie www.pictures-bank.eu). Autorem zdjęcia jest Piotr Kożurno\"],\"title\":[\"Poznań - 49 Dąbrowskiego St\",\"Poznań - ul. Dąbrowskiego 49\"],\"edmPlaceLabel\":[{\"def\":\"Posen\"},{\"def\":\"Posen\"},{\"def\":\"Woiwodschaft Großpolen\"},{\"def\":\"Posen\"},{\"def\":\"Polen\"},{\"def\":\"Горад Познань\"},{\"def\":\"Познань\"},{\"def\":\"Горад Познань\"},{\"def\":\"Польша\"},{\"def\":\"Польшча\"},{\"def\":\"Познань\"},{\"def\":\"Познань\"},{\"def\":\"Великопольское воеводство\"},{\"def\":\"Познань\"},{\"def\":\"Польша\"},{\"def\":\"Poznań\"},{\"def\":\"Poznań\"},{\"def\":\"Poznań\"},{\"def\":\"Województwo Wielkopolskie\"},{\"def\":\"Poznań\"},{\"def\":\"Poznań\"},{\"def\":\"Republic of Poland\"},{\"def\":\"Познан\"},{\"def\":\"Познан\"},{\"def\":\"Познан\"},{\"def\":\"Полша\"},{\"def\":\"Poznanė\"},{\"def\":\"Poznanė\"},{\"def\":\"Didžiosios Lenkijos vaivadija\"},{\"def\":\"Poznanė\"},{\"def\":\"Lenkija\"},{\"def\":\"Poznanj\"},{\"def\":\"Poznanj\"},{\"def\":\"Poljska\"},{\"def\":\"Poznaņa\"},{\"def\":\"Poznaņa\"},{\"def\":\"Lielpolijas vojevodiste\"},{\"def\":\"Poznaņa\"},{\"def\":\"Polija\"},{\"def\":\"Poznań\"},{\"def\":\"Poznań\"},{\"def\":\"Voïvodie de Grande-Pologne\"},{\"def\":\"Pologne\"},{\"def\":\"ཕྰོ་ཟོ་ནན།\"},{\"def\":\"ཕྰོ་ཟོ་ནན།\"},{\"def\":\"པོ་ལནྜ།\"},{\"def\":\"פויזן\"},{\"def\":\"פויזן\"},{\"def\":\"פוילן\"},{\"def\":\"Poznanj\"},{\"def\":\"Poznanj\"},{\"def\":\"Poljska\"},{\"def\":\"Poznan\"},{\"def\":\"Poznan\"},{\"def\":\"لەھىستان\"},{\"def\":\"Poznan\"},{\"def\":\"Poznan\"},{\"def\":\"Poalen\"},{\"def\":\"Познань\"},{\"def\":\"Познань\"},{\"def\":\"Польща\"},{\"def\":\"პოზნანი\"},{\"def\":\"პოზნანი\"},{\"def\":\"პოზნანი\"},{\"def\":\"პოლონეთი\"},{\"def\":\"Poznaň\"},{\"def\":\"Poznaň\"},{\"def\":\"Poznaň\"},{\"def\":\"Poľsko\"},{\"def\":\"Poznanj\"},{\"def\":\"Poznanj\"},{\"def\":\"Poljska\"},{\"def\":\"Познањ\"},{\"def\":\"Војводство великопољско\"},{\"def\":\"Познањ\"},{\"def\":\"Пољска\"},{\"def\":\"Познань\"},{\"def\":\"Познань\"},{\"def\":\"Польшæ\"},{\"def\":\"포즈난\"},{\"def\":\"포즈난\"},{\"def\":\"포즈난\"},{\"def\":\"폴란드\"},{\"def\":\"पोझ्नान\"},{\"def\":\"पोझ्नान\"},{\"def\":\"पोलंड\"},{\"def\":\"Πόζναν\"},{\"def\":\"Πόζναν\"},{\"def\":\"Πολωνία\"},{\"def\":\"Poznań\"},{\"def\":\"Poznań\"},{\"def\":\"Greater Poland Voivodeship\"},{\"def\":\"Poland\"},{\"def\":\"Republic of Poland\"},{\"def\":\"波茲南\"},{\"def\":\"波茲南\"},{\"def\":\"大波兰省\"},{\"def\":\"波茲南\"},{\"def\":\"波兰\"},{\"def\":\"Poznaň\"},{\"def\":\"Poznaň\"},{\"def\":\"Velkopolské vojvodství\"},{\"def\":\"Poznaň\"},{\"def\":\"Polsko\"},{\"def\":\"بوزنان\"},{\"def\":\"بوزنان\"},{\"def\":\"بولندا\"},{\"def\":\"Posnania\"},{\"def\":\"Posnania\"},{\"def\":\"Posnania\"},{\"def\":\"Polonia\"},{\"def\":\"ポズナン\"},{\"def\":\"ポズナン\"},{\"def\":\"ヴィエルコポルスカ県\"},{\"def\":\"ポズナン\"},{\"def\":\"ポーランド\"},{\"def\":\"ポーランド共和国\"},{\"def\":\"پوزنان\"},{\"def\":\"پوزنان\"},{\"def\":\"اتریش\"},{\"def\":\"لهستان\"},{\"def\":\"פוזנן\"},{\"def\":\"פוזנן\"},{\"def\":\"פולין\"},{\"def\":\"Poznań\"},{\"def\":\"Storpolske voivodskap\"},{\"def\":\"Polen\"},{\"def\":\"Poznań\"},{\"def\":\"Puola\"},{\"def\":\"Poznań\"},{\"def\":\"Grande Polônia\"},{\"def\":\"Polónia\"},{\"def\":\"Polônia\"},{\"def\":\"Poznań\"},{\"def\":\"Lengyelország\"},{\"def\":\"Poznań\"},{\"def\":\"Provinsi Polandia Besar\"},{\"def\":\"Polandia\"},{\"def\":\"Poznań\"},{\"def\":\"Storpolen\"},{\"def\":\"Storpolens vojvodskap\"},{\"def\":\"Polen\"},{\"def\":\"Poznań\"},{\"def\":\"Grandpolio\"},{\"def\":\"Grandpollanda Provinco\"},{\"def\":\"Poznano\"},{\"def\":\"Polio\"},{\"def\":\"Pollando\"},{\"def\":\"Polujo\"},{\"def\":\"Poznań\"},{\"def\":\"Pólland\"},{\"def\":\"Poznań\"},{\"def\":\"Voivodato della Grande Polonia\"},{\"def\":\"Polonia\"},{\"def\":\"Poznań\"},{\"def\":\"Voivodato de Gran Polonia\"},{\"def\":\"Posnania\"},{\"def\":\"Polonia\"},{\"def\":\"Poznań\"},{\"def\":\"Suur-Poola vojevoodkond\"},{\"def\":\"Poola\"},{\"def\":\"Poznan\"},{\"def\":\"Polonia\"},{\"def\":\"Poznań\"},{\"def\":\"Poran\"},{\"def\":\"Poznań\"},{\"def\":\"Województwo wielkopolskie\"},{\"def\":\"Polska\"},{\"def\":\"Rzeczpospolita Polska\"},{\"def\":\"Poznań\"},{\"def\":\"Polen\"},{\"def\":\"Poznań\"},{\"def\":\"Voievodatul Polonia Mare\"},{\"def\":\"Polonia\"},{\"def\":\"Полония\"},{\"def\":\"Poznań\"},{\"def\":\"Woiwodschap Groot-Polen\"},{\"def\":\"Polen\"},{\"def\":\"Voivodat de Gran Polònia\"},{\"def\":\"Polònia\"},{\"def\":\"Познань\"},{\"def\":\"Պոզնան\"},{\"def\":\"Լեհաստան\"},{\"def\":\"پوزنان\"},{\"def\":\"پولینڈ\"},{\"def\":\"Познань\"},{\"def\":\"போசுனான்\"},{\"def\":\"போலந்து\"},{\"def\":\"Познань\"},{\"def\":\"พอซนาน\"},{\"def\":\"ประเทศโปแลนด์\"},{\"def\":\"โปแลนด์\"},{\"def\":\"Poznan\"},{\"def\":\"Polşa\"},{\"def\":\"पोलैंड\"},{\"def\":\"پولنډ\"},{\"def\":\"Orílẹ́ède Polandi\"},{\"def\":\"Polonia\"},{\"def\":\"Pulska\"},{\"def\":\"Pulunya\"},{\"def\":\"Pole\"},{\"def\":\"Polonia\"},{\"def\":\"Poland\"},{\"def\":\"ፖላንድ\"},{\"def\":\"Polonia\"},{\"def\":\"Pologna\"},{\"def\":\"i-Poland\"},{\"def\":\"Polonye\"},{\"def\":\"Poloɲi\"},{\"def\":\"Polandia\"},{\"def\":\"পোল্যাণ্ড\"},{\"def\":\"পোল্যান্ড\"},{\"def\":\"Polonia\"},{\"def\":\"Polonia\"},{\"def\":\"Polen\"},{\"def\":\"Polska\"},{\"def\":\"Pölôni\"},{\"def\":\"පෝලන්තය\"},{\"def\":\"Poland\"},{\"def\":\"Booland\"},{\"def\":\"Polandi\"},{\"def\":\"Poloni\"},{\"def\":\"Polonia\"},{\"def\":\"Польша\"},{\"def\":\"Poleni\"},{\"def\":\"ប៉ូលូញ\"},{\"def\":\"ಪೋಲ್ಯಾಂಡ್\"},{\"def\":\"Poland\"},{\"def\":\"Polandi\"},{\"def\":\"Polonya\"},{\"def\":\"پۆڵەندا\"},{\"def\":\"Poloni\"},{\"def\":\"పోలాండ్\"},{\"def\":\"Пол҄ьска\"},{\"def\":\"Лаҳистон\"},{\"def\":\"Польша\"},{\"def\":\"ፖላንድ\"},{\"def\":\"Gwlad Pwyl\"},{\"def\":\"Polen\"},{\"def\":\"Polonya\"},{\"def\":\"poland\"},{\"def\":\"Polandi\"},{\"def\":\"Poleni\"},{\"def\":\"Pole\"},{\"def\":\"Polonya\"},{\"def\":\"Poloni\"},{\"def\":\"ໂປແລນ\"},{\"def\":\"Mpoloni\"},{\"def\":\"Pôlôna\"},{\"def\":\"Полска\"},{\"def\":\"പോളണ്ട്\"},{\"def\":\"Poland nutome\"},{\"def\":\"Polsha\"},{\"def\":\"Poland\"},{\"def\":\"Polonja\"},{\"def\":\"ပိုလန်\"},{\"def\":\"Ba Lan\"},{\"def\":\"Polen\"},{\"def\":\"Pholandi\"},{\"def\":\"पोल्याण्ड\"},{\"def\":\"Polän\"},{\"def\":\"Polen\"},{\"def\":\"Poloñ\"},{\"def\":\"Pólland\"},{\"def\":\"Polonha\"},{\"def\":\"An Pholainn\"},{\"def\":\"A Phòlainn\"},{\"def\":\"ପୋଲାଣ୍ଡ\"},{\"def\":\"Polonia\"},{\"def\":\"Polonia - Polska\"},{\"def\":\"Polóña\"},{\"def\":\"પોલેંડ\"},{\"def\":\"Yn Pholynn\"},{\"def\":\"Polan\"}],\"edmPlaceLatitude\":[\"52.40619\",\"52.4079\",\"52.40929\",\"52.3\",\"52.40692\",\"52.40063\",\"52.0\"],\"edmPlaceLongitude\":[\"16.92341\",\"16.91886\",\"16.93122\",\"17.2\",\"16.92993\",\"16.90154\",\"20.0\"],\"dcContributor\":[\"Piotr Kożurno\"],\"edmPreview\":[\"https://api.europeana.eu/api/v2/thumbnail-by-url.json?uri=http%3A%2F%2Fwww.pictures-bank.eu%2Fpokazobrazek.php%3Ffileno%3D61725%26a%3D1&type=IMAGE\"],\"edmPlaceLabelLangAware\":{\"hi\":[\"पोलैंड\"],\"ps\":[\"پولنډ\"],\"pt\":[\"Poznań\",\"Grande Polônia\",\"Polónia\",\"Polônia\"],\"def\":[\"Poznań\",\"Poznań\",\"Poznań\",\"Województwo Wielkopolskie\",\"Poznań\",\"Poznań\",\"Republic of Poland\"],\"hr\":[\"Poznanj\",\"Poznanj\",\"Poljska\"],\"hu\":[\"Poznań\",\"Lengyelország\"],\"yi\":[\"פויזן\",\"פויזן\",\"פוילן\"],\"hy\":[\"Պոզնան\",\"Լեհաստան\"],\"yo\":[\"Orílẹ́ède Polandi\"],\"ia\":[\"Polonia\"],\"id\":[\"Poznań\",\"Provinsi Polandia Besar\",\"Polandia\"],\"qu\":[\"Pulska\",\"Pulunya\"],\"af\":[\"Pole\"],\"io\":[\"Polonia\"],\"is\":[\"Poznań\",\"Pólland\"],\"ak\":[\"Poland\"],\"it\":[\"Poznań\",\"Voivodato della Grande Polonia\",\"Polonia\"],\"am\":[\"ፖላንድ\"],\"an\":[\"Polonia\"],\"zh\":[\"波茲南\",\"波茲南\",\"大波兰省\",\"波茲南\",\"波兰\"],\"ar\":[\"بوزنان\",\"بوزنان\",\"بولندا\"],\"ja\":[\"ポズナン\",\"ポズナン\",\"ヴィエルコポルスカ県\",\"ポズナン\",\"ポーランド\",\"ポーランド共和国\"],\"az\":[\"Poznan\",\"Polşa\"],\"rm\":[\"Pologna\"],\"zu\":[\"i-Poland\"],\"rn\":[\"Polonye\"],\"ro\":[\"Poznań\",\"Voievodatul Polonia Mare\",\"Polonia\",\"Полония\"],\"be\":[\"Горад Познань\",\"Познань\",\"Горад Познань\",\"Польша\",\"Польшча\"],\"ru\":[\"Познань\",\"Познань\",\"Великопольское воеводство\",\"Познань\",\"Польша\"],\"bg\":[\"Познан\",\"Познан\",\"Познан\",\"Полша\"],\"bm\":[\"Poloɲi\"],\"jv\":[\"Polandia\"],\"bn\":[\"পোল্যাণ্ড\",\"পোল্যান্ড\"],\"bo\":[\"ཕྰོ་ཟོ་ནན།\",\"ཕྰོ་ཟོ་ནན།\",\"པོ་ལནྜ།\"],\"br\":[\"Polonia\"],\"sc\":[\"Polonia\"],\"bs\":[\"Poznanj\",\"Poznanj\",\"Poljska\"],\"se\":[\"Polen\",\"Polska\"],\"sg\":[\"Pölôni\"],\"ka\":[\"პოზნანი\",\"პოზნანი\",\"პოზნანი\",\"პოლონეთი\"],\"si\":[\"පෝලන්තය\"],\"sk\":[\"Poznaň\",\"Poznaň\",\"Poznaň\",\"Poľsko\"],\"sl\":[\"Poznanj\",\"Poznanj\",\"Poljska\"],\"sn\":[\"Poland\"],\"so\":[\"Booland\"],\"ca\":[\"Voivodat de Gran Polònia\",\"Polònia\"],\"ki\":[\"Polandi\"],\"sq\":[\"Poloni\",\"Polonia\"],\"sr\":[\"Познањ\",\"Војводство великопољско\",\"Познањ\",\"Пољска\"],\"kk\":[\"Польша\"],\"kl\":[\"Poleni\"],\"ce\":[\"Познань\"],\"km\":[\"ប៉ូលូញ\"],\"sv\":[\"Poznań\",\"Storpolen\",\"Storpolens vojvodskap\",\"Polen\"],\"kn\":[\"ಪೋಲ್ಯಾಂಡ್\"],\"ko\":[\"포즈난\",\"포즈난\",\"포즈난\",\"폴란드\"],\"sw\":[\"Poland\",\"Polandi\"],\"ku\":[\"Polonya\",\"پۆڵەندا\"],\"kw\":[\"Poloni\"],\"ta\":[\"போசுனான்\",\"போலந்து\"],\"ky\":[\"Познань\"],\"cs\":[\"Poznaň\",\"Poznaň\",\"Velkopolské vojvodství\",\"Poznaň\",\"Polsko\"],\"te\":[\"పోలాండ్\"],\"cu\":[\"Пол҄ьска\"],\"tg\":[\"Лаҳистон\"],\"cv\":[\"Польша\"],\"th\":[\"พอซนาน\",\"ประเทศโปแลนด์\",\"โปแลนด์\"],\"la\":[\"Posnania\",\"Posnania\",\"Posnania\",\"Polonia\"],\"ti\":[\"ፖላንድ\"],\"cy\":[\"Gwlad Pwyl\"],\"lb\":[\"Polen\"],\"tl\":[\"Polonya\",\"poland\"],\"lg\":[\"Polandi\"],\"to\":[\"Poleni\"],\"da\":[\"Poznań\",\"Polen\"],\"li\":[\"Pole\"],\"tr\":[\"Polonya\"],\"tt\":[\"Познань\"],\"de\":[\"Posen\",\"Posen\",\"Woiwodschaft Großpolen\",\"Posen\",\"Polen\"],\"ln\":[\"Poloni\"],\"lo\":[\"ໂປແລນ\"],\"lt\":[\"Poznanė\",\"Poznanė\",\"Didžiosios Lenkijos vaivadija\",\"Poznanė\",\"Lenkija\"],\"lu\":[\"Mpoloni\"],\"lv\":[\"Poznaņa\",\"Poznaņa\",\"Lielpolijas vojevodiste\",\"Poznaņa\",\"Polija\"],\"ug\":[\"Poznan\",\"Poznan\",\"لەھىستان\"],\"uk\":[\"Познань\",\"Познань\",\"Польща\"],\"mg\":[\"Pôlôna\"],\"ur\":[\"پوزنان\",\"پولینڈ\"],\"mk\":[\"Полска\"],\"ml\":[\"പോളണ്ട്\"],\"ee\":[\"Poland nutome\"],\"mr\":[\"पोझ्नान\",\"पोझ्नान\",\"पोलंड\"],\"uz\":[\"Polsha\"],\"ms\":[\"Poland\"],\"el\":[\"Πόζναν\",\"Πόζναν\",\"Πολωνία\"],\"mt\":[\"Polonja\"],\"en\":[\"Poznań\",\"Poznań\",\"Greater Poland Voivodeship\",\"Poland\",\"Republic of Poland\"],\"eo\":[\"Poznań\",\"Grandpolio\",\"Grandpollanda Provinco\",\"Poznano\",\"Polio\",\"Pollando\",\"Polujo\"],\"my\":[\"ပိုလန်\"],\"es\":[\"Poznań\",\"Voivodato de Gran Polonia\",\"Posnania\",\"Polonia\"],\"et\":[\"Poznań\",\"Suur-Poola vojevoodkond\",\"Poola\"],\"eu\":[\"Poznan\",\"Polonia\"],\"na\":[\"Poznań\",\"Poran\"],\"vi\":[\"Ba Lan\"],\"nb\":[\"Polen\"],\"nd\":[\"Pholandi\"],\"ne\":[\"पोल्याण्ड\"],\"vo\":[\"Polän\"],\"fa\":[\"پوزنان\",\"پوزنان\",\"اتریش\",\"لهستان\"],\"nl\":[\"Poznań\",\"Woiwodschap Groot-Polen\",\"Polen\"],\"nn\":[\"Polen\"],\"ff\":[\"Poloñ\"],\"no\":[\"Poznań\",\"Storpolske voivodskap\",\"Polen\"],\"fi\":[\"Poznań\",\"Puola\"],\"fo\":[\"Pólland\"],\"fr\":[\"Poznań\",\"Poznań\",\"Voïvodie de Grande-Pologne\",\"Pologne\"],\"fy\":[\"Poznan\",\"Poznan\",\"Poalen\"],\"oc\":[\"Polonha\"],\"ga\":[\"An Pholainn\"],\"gd\":[\"A Phòlainn\"],\"or\":[\"ପୋଲାଣ୍ଡ\"],\"os\":[\"Познань\",\"Познань\",\"Польшæ\"],\"gl\":[\"Polonia\",\"Polonia - Polska\"],\"gn\":[\"Polóña\"],\"gu\":[\"પોલેંડ\"],\"gv\":[\"Yn Pholynn\"],\"ha\":[\"Polan\"],\"pl\":[\"Poznań\",\"Województwo wielkopolskie\",\"Polska\",\"Rzeczpospolita Polska\"],\"he\":[\"פוזנן\",\"פוזנן\",\"פולין\"]},\"dataProvider\":[\"Pictures-bank.eu (ICIMSS)\"],\"rights\":[\"http://rightsstatements.org/vocab/InC/1.0/\"],\"dctermsSpatial\":[\"Poznań\",\"http://data.europeana.eu/place/base/136139\",\"http://data.europeana.eu/place/base/134853\",\"http://data.europeana.eu/place/base/134852\",\"http://data.europeana.eu/place/base/134511\",\"http://data.europeana.eu/place/base/135168\",\"http://data.europeana.eu/place/base/108\"],\"edmIsShownAt\":[\"https://api.europeana.eu/api/api2demo/redirect?shownAt=http%3A%2F%2Fwww.pictures-bank.eu%2Findex.php%3Faction%3Dprzegladaj_zdjecie%26id%3D61725&provider=AthenaPlus&id=https%3A%2F%2Fwww.europeana.eu%2Fresolve%2Frecord%2F2048017%2FAthena_Plus_ProvidedCHO_Pictures_bank_eu__ICIMSS__61725&profile=rich%2Cfacets\"],\"edmPlace\":[\"http://data.europeana.eu/place/base/136139\",\"http://data.europeana.eu/place/base/134853\",\"http://data.europeana.eu/place/base/134852\",\"http://data.europeana.eu/place/base/134712\",\"http://data.europeana.eu/place/base/134511\",\"http://data.europeana.eu/place/base/135168\",\"http://data.europeana.eu/place/base/108\"],\"previewNoDistribute\":false,\"dcTitleLangAware\":{\"en\":[\"Poznań - 49 Dąbrowskiego St\"],\"pl\":[\"Poznań - ul. Dąbrowskiego 49\"]},\"dcContributorLangAware\":{\"pl\":[\"Piotr Kożurno\"]},\"provider\":[\"AthenaPlus\"],\"timestamp\":1538717791576,\"score\":12.913504,\"language\":[\"pl\"],\"type\":\"IMAGE\",\"edmDatasetName\":[\"2048017_Ag_EU_AthenaPlus_ICIMSS\"],\"guid\":\"https://www.europeana.eu/portal/record/2048017/Athena_Plus_ProvidedCHO_Pictures_bank_eu__ICIMSS__61725.html?utm_source=api&utm_medium=api&utm_campaign=api2demo\",\"link\":\"https://api.europeana.eu/api/v2/record/2048017/Athena_Plus_ProvidedCHO_Pictures_bank_eu__ICIMSS__61725.json?wskey=api2demo\",\"timestamp_created_epoch\":1402407317224,\"timestamp_update_epoch\":1444764130088,\"timestamp_created\":\"2014-06-10T13:35:17.224Z\",\"timestamp_update\":\"2015-10-13T19:22:10.088Z\"}],\"facets\":[{\"name\":\"DATA_PROVIDER\",\"fields\":[{\"label\":\"Wielkopolska Biblioteka Cyfrowa\",\"count\":69483}]}]}";

    @Mock
    private WebClient webTestClient;

    @InjectMocks
    private SearchService searchService = new SearchService(WebClient.builder());

    private void mockWebClientResponse(final String resp) {
        final WebClient.RequestHeadersUriSpec uriSpecMock = Mockito.mock(WebClient.RequestHeadersUriSpec.class);
        final WebClient.RequestHeadersSpec headersSpecMock = Mockito.mock(WebClient.RequestHeadersSpec.class);
        final WebClient.ResponseSpec responseSpecMock = Mockito.mock(WebClient.ResponseSpec.class);
        final ClientResponse response = Mockito.mock(ClientResponse.class);

        when(webTestClient.get()).thenReturn(uriSpecMock);
        when(uriSpecMock.uri(ArgumentMatchers.<String>notNull(), ArgumentMatchers.<String>notNull(), ArgumentMatchers.any())).thenReturn(headersSpecMock);
        when(headersSpecMock.header(notNull(), notNull())).thenReturn(headersSpecMock);
        when(headersSpecMock.headers(notNull())).thenReturn(headersSpecMock);
        when(headersSpecMock.retrieve()).thenReturn(responseSpecMock);
        when(responseSpecMock.onStatus(ArgumentMatchers.any(Predicate.class), ArgumentMatchers.any(Function.class)))
                .thenReturn(responseSpecMock);
        when(responseSpecMock.bodyToMono(ArgumentMatchers.<Class<String>>notNull()))
                .thenReturn(Mono.just(resp));
    }

    @Test(expected = IllegalStateException.class)
    public void searchWhenNoParameters() {
        searchService.search("", null);
    }

    @Test
    public void searchWhenResultsOK() {
        mockWebClientResponse(RESPONSE_OK);
        Mono<String> response = searchService.search("abc", null);

        Assert.assertNotNull(response);
        Assert.assertEquals(response.block(), RESPONSE_OK);
    }
}