package pl.psnc.dei.service.searchresultprocessor;

import org.apache.jena.atlas.json.JSON;
import org.apache.jena.atlas.json.JsonObject;
import org.junit.Assert;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.springframework.test.context.junit4.SpringRunner;
import pl.psnc.dei.schema.search.SearchResult;
import pl.psnc.dei.service.RecordDataCache;
import pl.psnc.dei.service.search.EuropeanaSearchService;
import pl.psnc.dei.util.IiifAvailability;

import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.*;

@RunWith(SpringRunner.class)
public class EuropeanaSearchResultProcessorTest {

	private final JsonObject europeanaRestResponseIiif = JSON.parse("{ \"@context\" : { \"ore\" : \"http://www.openarchives.org/ore/terms/\" , \"skos\" : \"http://www.w3.org/2004/02/skos/core#\" , \"dc\" : \"http://purl.org/dc/elements/1.1/\" , \"edm\" : \"http://www.europeana.eu/schemas/edm/\" , \"rdf\" : \"http://www.w3.org/1999/02/22-rdf-syntax-ns#\" , \"dcterms\" : \"http://purl.org/dc/terms/\" , \"foaf\" : \"http://xmlns.com/foaf/0.1/\" , \"geo\" : \"http://www.w3.org/2003/01/geo/wgs84_pos#\" } , \"@graph\" : [ { \"@id\" : \"http://data.europeana.eu/aggregation/europeana/9200579/zup9etsy\" , \"@type\" : \"edm:EuropeanaAggregation\" , \"dcterms:created\" : \"2018-01-29T14:33:09.862Z\" , \"dcterms:modified\" : \"2018-01-31T11:37:45.791Z\" , \"edm:aggregatedCHO\" : {\"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" } , \"edm:completeness\" : \"7\" , \"edm:country\" : \"United Kingdom\" , \"edm:datasetName\" : \"9200579_Ag_UK_WellcomeCollection_IIIF\" , \"edm:landingPage\" : {\"@id\" : \"https://www.europeana.eu/portal/record/9200579/zup9etsy.html\" } , \"edm:language\" : \"en\" , \"edm:preview\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/full/0/default.jpg\" } } , { \"@id\" : \"http://data.europeana.eu/aggregation/provider/9200579/zup9etsy\" , \"@type\" : \"ore:Aggregation\" , \"edm:aggregatedCHO\" : {\"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" } , \"edm:dataProvider\" : \"Wellcome Collection\" , \"edm:isShownAt\" : {\"@id\" : \"https://wellcomecollection.org/works/zup9etsy\" } , \"edm:isShownBy\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/512,/0/default.jpg\" } , \"edm:object\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/full/0/default.jpg\" } , \"edm:provider\" : \"Wellcome Collection\" , \"edm:rights\" : {\"@id\" : \"http://creativecommons.org/licenses/by/4.0/\" } } , { \"@id\" : \"http://data.europeana.eu/concept/base/1720\" , \"@type\" : \"skos:Concept\" , \"skos:altLabel\" : { \"@language\" : \"de\" , \"@value\" : \"Photographische prints\" } , \"skos:broader\" : {\"@id\" : \"http://data.europeana.eu/concept/base/1684\" } , \"skos:exactMatch\" : {\"@id\" : \"http://bib.arts.kuleuven.be/photoVocabulary/-photoVocabulary-11007\" } , \"skos:narrower\" : [ { \"@id\" : \"http://data.europeana.eu/concept/base/1695\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1690\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1697\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1696\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1703\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1692\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1699\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1702\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1689\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1700\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1691\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1698\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1701\" } ] , \"skos:prefLabel\" : [ { \"@language\" : \"zh\" , \"@value\" : \"印制品\" } , { \"@language\" : \"pl\" , \"@value\" : \"Odbitki fotograficzne\" } , { \"@language\" : \"de\" , \"@value\" : \"Fotografische Abzüge\" } , { \"@language\" : \"en\" , \"@value\" : \"Photographic prints\" } , { \"@language\" : \"da\" , \"@value\" : \"Fotografiske prints\" } , { \"@language\" : \"it\" , \"@value\" : \"Stampe fotografiche\" } , { \"@language\" : \"bg\" , \"@value\" : \"Фотографски отпечатъци\" } , { \"@language\" : \"es\" , \"@value\" : \"Impresiones fotográficas\" } , { \"@language\" : \"uk\" , \"@value\" : \"Фотографічні відбитки (відтиски)\" } , { \"@language\" : \"sl\" , \"@value\" : \"Fototlač\" } , { \"@language\" : \"lt\" , \"@value\" : \"Fotografinai atspaudai\" } , { \"@language\" : \"nl\" , \"@value\" : \"Fotografische afdruk\" } , { \"@language\" : \"ca\" , \"@value\" : \"Còpia fotogràfica\" } , { \"@language\" : \"fr\" , \"@value\" : \"Épreuve photographique\" } , { \"@language\" : \"ru\" , \"@value\" : \"Фотографические отпечатки (оттиски)\" } ] } , { \"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" , \"@type\" : \"edm:ProvidedCHO\" } , { \"@id\" : \"http://data.europeana.eu/proxy/europeana/9200579/zup9etsy\" , \"@type\" : \"ore:Proxy\" , \"dc:date\" : {\"@id\" : \"http://semium.org/time/18xx_2_half\" } , \"dc:type\" : {\"@id\" : \"http://data.europeana.eu/concept/base/1720\" } , \"dcterms:created\" : [ { \"@id\" : \"http://semium.org/time/18xx\" } , { \"@id\" : \"http://semium.org/time/1876\" } ] , \"edm:europeanaProxy\" : \"true\" , \"edm:type\" : \"IMAGE\" , \"edm:year\" : \"1876\" , \"ore:proxyFor\" : {\"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" } , \"ore:proxyIn\" : {\"@id\" : \"http://data.europeana.eu/aggregation/europeana/9200579/zup9etsy\" } } , { \"@id\" : \"http://data.europeana.eu/proxy/provider/9200579/zup9etsy\" , \"@type\" : \"ore:Proxy\" , \"dc:description\" : { \"@language\" : \"en\" , \"@value\" : \"Lettering: International Exposition; Philadelphia, 1876; War Department, Surgeon General's office, Army Medical Museum; model of freight car (sometimes used to transport the wounded)\\n\\nLettering: printed on mount.\" } , \"dc:identifier\" : [ \"Iconographic Collection 572966i\" , \"zup9etsy\" , \"b1572966\" , \"V0038454\" ] , \"dc:rights\" : \"Credit: Wellcome Collection\" , \"dc:source\" : \"V0038454\" , \"dc:title\" : \"Philadelphia International Exposition, 1876: American Civil War freight car: a model. Photograph, 1876.\" , \"dc:type\" : { \"@language\" : \"en\" , \"@value\" : \"Photographic prints\" } , \"dcterms:created\" : \"1876\" , \"edm:europeanaProxy\" : \"false\" , \"edm:type\" : \"IMAGE\" , \"ore:proxyFor\" : {\"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" } , \"ore:proxyIn\" : {\"@id\" : \"http://data.europeana.eu/aggregation/provider/9200579/zup9etsy\" } } , { \"@id\" : \"http://semium.org/time/1876\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/18xx_4_quarter\" } , \"edm:begin\" : \"Sat Jan 01 01:00:00 CET 1876\" , \"edm:end\" : \"Sun Dec 31 01:00:00 CET 1876\" , \"skos:prefLabel\" : \"1876\" } , { \"@id\" : \"http://semium.org/time/18xx\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/AD2xxx\" } , \"edm:begin\" : \"Thu Jan 01 01:00:00 CET 1801\" , \"edm:end\" : \"Mon Dec 31 00:19:32 CET 1900\" , \"skos:prefLabel\" : [ { \"@language\" : \"ru\" , \"@value\" : \"19й век\" } , { \"@language\" : \"en\" , \"@value\" : \"19th\" } , { \"@language\" : \"en\" , \"@value\" : \"19th century\" } , \"19..\" , \"19e\" , { \"@language\" : \"fr\" , \"@value\" : \"19e siècle\" } , \"19??\" , { \"@language\" : \"nl\" , \"@value\" : \"19de eeuw\" } , { \"@language\" : \"en\" , \"@value\" : \"19-th\" } ] } , { \"@id\" : \"http://semium.org/time/18xx_2_half\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/18xx\" } , \"edm:begin\" : \"Wed Jan 01 01:00:00 CET 1851\" , \"edm:end\" : \"Tue Dec 31 00:19:32 CET 1901\" , \"skos:prefLabel\" : [ { \"@language\" : \"fr\" , \"@value\" : \"19e (fin)\" } , { \"@language\" : \"en\" , \"@value\" : \"Second half of the 19th century\" } , { \"@language\" : \"ru\" , \"@value\" : \"Вторая половина 19-го века\" } ] } , { \"@id\" : \"http://semium.org/time/18xx_4_quarter\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/18xx_2_half\" } , \"edm:begin\" : \"Sat Jan 01 01:00:00 CET 1876\" , \"edm:end\" : \"Mon Dec 31 00:19:32 CET 1900\" , \"skos:prefLabel\" : [ { \"@language\" : \"fr\" , \"@value\" : \"4e quart 19e siècle\" } , { \"@language\" : \"en\" , \"@value\" : \"4 quarter of the 19th century\" } , { \"@language\" : \"ru\" , \"@value\" : \"4-я четверть 19-го века\" } ] } , { \"@id\" : \"http://semium.org/time/AD2xxx\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/ChronologicalPeriod\" } , \"skos:prefLabel\" : [ { \"@language\" : \"fr\" , \"@value\" : \"2e millénaire après J.-C.\" } , { \"@language\" : \"en\" , \"@value\" : \"Second millenium AD, years 1001-2000\" } , { \"@language\" : \"en\" , \"@value\" : \"Second millenium AD\" } ] } , { \"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454\" , \"@type\" : \"http://rdfs.org/sioc/services#Service\" , \"dcterms:conformsTo\" : {\"@id\" : \"http://iiif.io/api/image\" } , \"http://usefulinc.com/ns/doap#implements\" : {\"@id\" : \"http://iiif.io/api/image/2/level2.json\" } } , { \"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/500,/0/default.jpg\" , \"@type\" : \"edm:WebResource\" } , { \"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/512,/0/default.jpg\" , \"@type\" : \"edm:WebResource\" , \"dcterms:isReferencedBy\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/info.json\" } , \"http://rdfs.org/sioc/services#has_service\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454\" } } , { \"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/full/0/default.jpg\" , \"@type\" : \"edm:WebResource\" , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#fileByteSize\" : { \"@type\" : \"http://www.w3.org/2001/XMLSchema#long\" , \"@value\" : \"2239568\" } , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#hasMimeType\" : \"image/jpeg\" , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#height\" : 2536 , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#orientation\" : \"landscape\" , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#width\" : 3012 , \"edm:componentColor\" : [ { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#F5DEB3\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#D2B48C\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#D3D3D3\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#BDB76B\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#BC8F8F\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#C0C0C0\" } ] , \"edm:hasColorSpace\" : \"sRGB\" } , { \"@id\" : \"https://wellcomecollection.org/works/zup9etsy\" , \"@type\" : \"edm:WebResource\" } ] }");
	private final JsonObject europeanaRestResponseNoIiif = JSON.parse("{ \"@context\" : { \"ore\" : \"http://www.openarchives.org/ore/terms/\" , \"skos\" : \"http://www.w3.org/2004/02/skos/core#\" , \"dc\" : \"http://purl.org/dc/elements/1.1/\" , \"edm\" : \"http://www.europeana.eu/schemas/edm/\" , \"rdf\" : \"http://www.w3.org/1999/02/22-rdf-syntax-ns#\" , \"dcterms\" : \"http://purl.org/dc/terms/\" , \"foaf\" : \"http://xmlns.com/foaf/0.1/\" , \"geo\" : \"http://www.w3.org/2003/01/geo/wgs84_pos#\" } , \"@graph\" : [ { \"@id\" : \"http://data.europeana.eu/aggregation/europeana/9200579/zup9etsy\" , \"@type\" : \"edm:EuropeanaAggregation\" , \"dcterms:created\" : \"2018-01-29T14:33:09.862Z\" , \"dcterms:modified\" : \"2018-01-31T11:37:45.791Z\" , \"edm:aggregatedCHO\" : {\"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" } , \"edm:completeness\" : \"7\" , \"edm:country\" : \"United Kingdom\" , \"edm:datasetName\" : \"9200579_Ag_UK_WellcomeCollection_IIIF\" , \"edm:landingPage\" : {\"@id\" : \"https://www.europeana.eu/portal/record/9200579/zup9etsy.html\" } , \"edm:language\" : \"en\" , \"edm:preview\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/full/0/default.jpg\" } } , { \"@id\" : \"http://data.europeana.eu/aggregation/provider/9200579/zup9etsy\" , \"@type\" : \"ore:Aggregation\" , \"edm:aggregatedCHO\" : {\"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" } , \"edm:dataProvider\" : \"Wellcome Collection\" , \"edm:isShownAt\" : {\"@id\" : \"https://wellcomecollection.org/works/zup9etsy\" } , \"edm:isShownBy\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/512,/0/default.jpg\" } , \"edm:object\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/full/0/default.jpg\" } , \"edm:provider\" : \"Wellcome Collection\" , \"edm:rights\" : {\"@id\" : \"http://creativecommons.org/licenses/by/4.0/\" } } , { \"@id\" : \"http://data.europeana.eu/concept/base/1720\" , \"@type\" : \"skos:Concept\" , \"skos:altLabel\" : { \"@language\" : \"de\" , \"@value\" : \"Photographische prints\" } , \"skos:broader\" : {\"@id\" : \"http://data.europeana.eu/concept/base/1684\" } , \"skos:exactMatch\" : {\"@id\" : \"http://bib.arts.kuleuven.be/photoVocabulary/-photoVocabulary-11007\" } , \"skos:narrower\" : [ { \"@id\" : \"http://data.europeana.eu/concept/base/1695\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1690\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1697\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1696\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1703\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1692\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1699\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1702\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1689\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1700\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1691\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1698\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1701\" } ] , \"skos:prefLabel\" : [ { \"@language\" : \"zh\" , \"@value\" : \"印制品\" } , { \"@language\" : \"pl\" , \"@value\" : \"Odbitki fotograficzne\" } , { \"@language\" : \"de\" , \"@value\" : \"Fotografische Abzüge\" } , { \"@language\" : \"en\" , \"@value\" : \"Photographic prints\" } , { \"@language\" : \"da\" , \"@value\" : \"Fotografiske prints\" } , { \"@language\" : \"it\" , \"@value\" : \"Stampe fotografiche\" } , { \"@language\" : \"bg\" , \"@value\" : \"Фотографски отпечатъци\" } , { \"@language\" : \"es\" , \"@value\" : \"Impresiones fotográficas\" } , { \"@language\" : \"uk\" , \"@value\" : \"Фотографічні відбитки (відтиски)\" } , { \"@language\" : \"sl\" , \"@value\" : \"Fototlač\" } , { \"@language\" : \"lt\" , \"@value\" : \"Fotografinai atspaudai\" } , { \"@language\" : \"nl\" , \"@value\" : \"Fotografische afdruk\" } , { \"@language\" : \"ca\" , \"@value\" : \"Còpia fotogràfica\" } , { \"@language\" : \"fr\" , \"@value\" : \"Épreuve photographique\" } , { \"@language\" : \"ru\" , \"@value\" : \"Фотографические отпечатки (оттиски)\" } ] } , { \"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" , \"@type\" : \"edm:ProvidedCHO\" } , { \"@id\" : \"http://data.europeana.eu/proxy/europeana/9200579/zup9etsy\" , \"@type\" : \"ore:Proxy\" , \"dc:date\" : {\"@id\" : \"http://semium.org/time/18xx_2_half\" } , \"dc:type\" : {\"@id\" : \"http://data.europeana.eu/concept/base/1720\" } , \"dcterms:created\" : [ { \"@id\" : \"http://semium.org/time/18xx\" } , { \"@id\" : \"http://semium.org/time/1876\" } ] , \"edm:europeanaProxy\" : \"true\" , \"edm:type\" : \"IMAGE\" , \"edm:year\" : \"1876\" , \"ore:proxyFor\" : {\"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" } , \"ore:proxyIn\" : {\"@id\" : \"http://data.europeana.eu/aggregation/europeana/9200579/zup9etsy\" } } , { \"@id\" : \"http://data.europeana.eu/proxy/provider/9200579/zup9etsy\" , \"@type\" : \"ore:Proxy\" , \"dc:description\" : { \"@language\" : \"en\" , \"@value\" : \"Lettering: International Exposition; Philadelphia, 1876; War Department, Surgeon General's office, Army Medical Museum; model of freight car (sometimes used to transport the wounded)\\n\\nLettering: printed on mount.\" } , \"dc:identifier\" : [ \"Iconographic Collection 572966i\" , \"zup9etsy\" , \"b1572966\" , \"V0038454\" ] , \"dc:rights\" : \"Credit: Wellcome Collection\" , \"dc:source\" : \"V0038454\" , \"dc:title\" : \"Philadelphia International Exposition, 1876: American Civil War freight car: a model. Photograph, 1876.\" , \"dc:type\" : { \"@language\" : \"en\" , \"@value\" : \"Photographic prints\" } , \"dcterms:created\" : \"1876\" , \"edm:europeanaProxy\" : \"false\" , \"edm:type\" : \"IMAGE\" , \"ore:proxyFor\" : {\"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" } , \"ore:proxyIn\" : {\"@id\" : \"http://data.europeana.eu/aggregation/provider/9200579/zup9etsy\" } } , { \"@id\" : \"http://semium.org/time/1876\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/18xx_4_quarter\" } , \"edm:begin\" : \"Sat Jan 01 01:00:00 CET 1876\" , \"edm:end\" : \"Sun Dec 31 01:00:00 CET 1876\" , \"skos:prefLabel\" : \"1876\" } , { \"@id\" : \"http://semium.org/time/18xx\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/AD2xxx\" } , \"edm:begin\" : \"Thu Jan 01 01:00:00 CET 1801\" , \"edm:end\" : \"Mon Dec 31 00:19:32 CET 1900\" , \"skos:prefLabel\" : [ { \"@language\" : \"ru\" , \"@value\" : \"19й век\" } , { \"@language\" : \"en\" , \"@value\" : \"19th\" } , { \"@language\" : \"en\" , \"@value\" : \"19th century\" } , \"19..\" , \"19e\" , { \"@language\" : \"fr\" , \"@value\" : \"19e siècle\" } , \"19??\" , { \"@language\" : \"nl\" , \"@value\" : \"19de eeuw\" } , { \"@language\" : \"en\" , \"@value\" : \"19-th\" } ] } , { \"@id\" : \"http://semium.org/time/18xx_2_half\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/18xx\" } , \"edm:begin\" : \"Wed Jan 01 01:00:00 CET 1851\" , \"edm:end\" : \"Tue Dec 31 00:19:32 CET 1901\" , \"skos:prefLabel\" : [ { \"@language\" : \"fr\" , \"@value\" : \"19e (fin)\" } , { \"@language\" : \"en\" , \"@value\" : \"Second half of the 19th century\" } , { \"@language\" : \"ru\" , \"@value\" : \"Вторая половина 19-го века\" } ] } , { \"@id\" : \"http://semium.org/time/18xx_4_quarter\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/18xx_2_half\" } , \"edm:begin\" : \"Sat Jan 01 01:00:00 CET 1876\" , \"edm:end\" : \"Mon Dec 31 00:19:32 CET 1900\" , \"skos:prefLabel\" : [ { \"@language\" : \"fr\" , \"@value\" : \"4e quart 19e siècle\" } , { \"@language\" : \"en\" , \"@value\" : \"4 quarter of the 19th century\" } , { \"@language\" : \"ru\" , \"@value\" : \"4-я четверть 19-го века\" } ] } , { \"@id\" : \"http://semium.org/time/AD2xxx\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/ChronologicalPeriod\" } , \"skos:prefLabel\" : [ { \"@language\" : \"fr\" , \"@value\" : \"2e millénaire après J.-C.\" } , { \"@language\" : \"en\" , \"@value\" : \"Second millenium AD, years 1001-2000\" } , { \"@language\" : \"en\" , \"@value\" : \"Second millenium AD\" } ] } , { \"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/500,/0/default.jpg\" , \"@type\" : \"edm:WebResource\" } , { \"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/512,/0/default.jpg\" , \"@type\" : \"edm:WebResource\" , \"dcterms:isReferencedBy\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/info.json\" } , \"http://rdfs.org/sioc/services#has_service\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454\" } } , { \"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/full/0/default.jpg\" , \"@type\" : \"edm:WebResource\" , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#fileByteSize\" : { \"@type\" : \"http://www.w3.org/2001/XMLSchema#long\" , \"@value\" : \"2239568\" } , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#hasMimeType\" : \"image/jpeg\" , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#height\" : 2536 , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#orientation\" : \"landscape\" , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#width\" : 3012 , \"edm:componentColor\" : [ { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#F5DEB3\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#D2B48C\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#D3D3D3\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#BDB76B\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#BC8F8F\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#C0C0C0\" } ] , \"edm:hasColorSpace\" : \"sRGB\" } , { \"@id\" : \"https://wellcomecollection.org/works/zup9etsy\" , \"@type\" : \"edm:WebResource\" } ] }");
	private final JsonObject europeanaRestResponseNoIiifWrongMimeType = JSON.parse("{ \"@context\" : { \"ore\" : \"http://www.openarchives.org/ore/terms/\" , \"skos\" : \"http://www.w3.org/2004/02/skos/core#\" , \"dc\" : \"http://purl.org/dc/elements/1.1/\" , \"edm\" : \"http://www.europeana.eu/schemas/edm/\" , \"rdf\" : \"http://www.w3.org/1999/02/22-rdf-syntax-ns#\" , \"dcterms\" : \"http://purl.org/dc/terms/\" , \"foaf\" : \"http://xmlns.com/foaf/0.1/\" , \"geo\" : \"http://www.w3.org/2003/01/geo/wgs84_pos#\" } , \"@graph\" : [ { \"@id\" : \"http://data.europeana.eu/aggregation/europeana/9200579/zup9etsy\" , \"@type\" : \"edm:EuropeanaAggregation\" , \"dcterms:created\" : \"2018-01-29T14:33:09.862Z\" , \"dcterms:modified\" : \"2018-01-31T11:37:45.791Z\" , \"edm:aggregatedCHO\" : {\"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" } , \"edm:completeness\" : \"7\" , \"edm:country\" : \"United Kingdom\" , \"edm:datasetName\" : \"9200579_Ag_UK_WellcomeCollection_IIIF\" , \"edm:landingPage\" : {\"@id\" : \"https://www.europeana.eu/portal/record/9200579/zup9etsy.html\" } , \"edm:language\" : \"en\" , \"edm:preview\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/full/0/default.jpg\" } } , { \"@id\" : \"http://data.europeana.eu/aggregation/provider/9200579/zup9etsy\" , \"@type\" : \"ore:Aggregation\" , \"edm:aggregatedCHO\" : {\"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" } , \"edm:dataProvider\" : \"Wellcome Collection\" , \"edm:isShownAt\" : {\"@id\" : \"https://wellcomecollection.org/works/zup9etsy\" } , \"edm:isShownBy\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/512,/0/default.jpg\" } , \"edm:object\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/full/0/default.jpg\" } , \"edm:provider\" : \"Wellcome Collection\" , \"edm:rights\" : {\"@id\" : \"http://creativecommons.org/licenses/by/4.0/\" } } , { \"@id\" : \"http://data.europeana.eu/concept/base/1720\" , \"@type\" : \"skos:Concept\" , \"skos:altLabel\" : { \"@language\" : \"de\" , \"@value\" : \"Photographische prints\" } , \"skos:broader\" : {\"@id\" : \"http://data.europeana.eu/concept/base/1684\" } , \"skos:exactMatch\" : {\"@id\" : \"http://bib.arts.kuleuven.be/photoVocabulary/-photoVocabulary-11007\" } , \"skos:narrower\" : [ { \"@id\" : \"http://data.europeana.eu/concept/base/1695\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1690\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1697\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1696\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1703\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1692\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1699\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1702\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1689\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1700\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1691\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1698\" } , { \"@id\" : \"http://data.europeana.eu/concept/base/1701\" } ] , \"skos:prefLabel\" : [ { \"@language\" : \"zh\" , \"@value\" : \"印制品\" } , { \"@language\" : \"pl\" , \"@value\" : \"Odbitki fotograficzne\" } , { \"@language\" : \"de\" , \"@value\" : \"Fotografische Abzüge\" } , { \"@language\" : \"en\" , \"@value\" : \"Photographic prints\" } , { \"@language\" : \"da\" , \"@value\" : \"Fotografiske prints\" } , { \"@language\" : \"it\" , \"@value\" : \"Stampe fotografiche\" } , { \"@language\" : \"bg\" , \"@value\" : \"Фотографски отпечатъци\" } , { \"@language\" : \"es\" , \"@value\" : \"Impresiones fotográficas\" } , { \"@language\" : \"uk\" , \"@value\" : \"Фотографічні відбитки (відтиски)\" } , { \"@language\" : \"sl\" , \"@value\" : \"Fototlač\" } , { \"@language\" : \"lt\" , \"@value\" : \"Fotografinai atspaudai\" } , { \"@language\" : \"nl\" , \"@value\" : \"Fotografische afdruk\" } , { \"@language\" : \"ca\" , \"@value\" : \"Còpia fotogràfica\" } , { \"@language\" : \"fr\" , \"@value\" : \"Épreuve photographique\" } , { \"@language\" : \"ru\" , \"@value\" : \"Фотографические отпечатки (оттиски)\" } ] } , { \"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" , \"@type\" : \"edm:ProvidedCHO\" } , { \"@id\" : \"http://data.europeana.eu/proxy/europeana/9200579/zup9etsy\" , \"@type\" : \"ore:Proxy\" , \"dc:date\" : {\"@id\" : \"http://semium.org/time/18xx_2_half\" } , \"dc:type\" : {\"@id\" : \"http://data.europeana.eu/concept/base/1720\" } , \"dcterms:created\" : [ { \"@id\" : \"http://semium.org/time/18xx\" } , { \"@id\" : \"http://semium.org/time/1876\" } ] , \"edm:europeanaProxy\" : \"true\" , \"edm:type\" : \"IMAGE\" , \"edm:year\" : \"1876\" , \"ore:proxyFor\" : {\"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" } , \"ore:proxyIn\" : {\"@id\" : \"http://data.europeana.eu/aggregation/europeana/9200579/zup9etsy\" } } , { \"@id\" : \"http://data.europeana.eu/proxy/provider/9200579/zup9etsy\" , \"@type\" : \"ore:Proxy\" , \"dc:description\" : { \"@language\" : \"en\" , \"@value\" : \"Lettering: International Exposition; Philadelphia, 1876; War Department, Surgeon General's office, Army Medical Museum; model of freight car (sometimes used to transport the wounded)\\n\\nLettering: printed on mount.\" } , \"dc:identifier\" : [ \"Iconographic Collection 572966i\" , \"zup9etsy\" , \"b1572966\" , \"V0038454\" ] , \"dc:rights\" : \"Credit: Wellcome Collection\" , \"dc:source\" : \"V0038454\" , \"dc:title\" : \"Philadelphia International Exposition, 1876: American Civil War freight car: a model. Photograph, 1876.\" , \"dc:type\" : { \"@language\" : \"en\" , \"@value\" : \"Photographic prints\" } , \"dcterms:created\" : \"1876\" , \"edm:europeanaProxy\" : \"false\" , \"edm:type\" : \"IMAGE\" , \"ore:proxyFor\" : {\"@id\" : \"http://data.europeana.eu/item/9200579/zup9etsy\" } , \"ore:proxyIn\" : {\"@id\" : \"http://data.europeana.eu/aggregation/provider/9200579/zup9etsy\" } } , { \"@id\" : \"http://semium.org/time/1876\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/18xx_4_quarter\" } , \"edm:begin\" : \"Sat Jan 01 01:00:00 CET 1876\" , \"edm:end\" : \"Sun Dec 31 01:00:00 CET 1876\" , \"skos:prefLabel\" : \"1876\" } , { \"@id\" : \"http://semium.org/time/18xx\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/AD2xxx\" } , \"edm:begin\" : \"Thu Jan 01 01:00:00 CET 1801\" , \"edm:end\" : \"Mon Dec 31 00:19:32 CET 1900\" , \"skos:prefLabel\" : [ { \"@language\" : \"ru\" , \"@value\" : \"19й век\" } , { \"@language\" : \"en\" , \"@value\" : \"19th\" } , { \"@language\" : \"en\" , \"@value\" : \"19th century\" } , \"19..\" , \"19e\" , { \"@language\" : \"fr\" , \"@value\" : \"19e siècle\" } , \"19??\" , { \"@language\" : \"nl\" , \"@value\" : \"19de eeuw\" } , { \"@language\" : \"en\" , \"@value\" : \"19-th\" } ] } , { \"@id\" : \"http://semium.org/time/18xx_2_half\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/18xx\" } , \"edm:begin\" : \"Wed Jan 01 01:00:00 CET 1851\" , \"edm:end\" : \"Tue Dec 31 00:19:32 CET 1901\" , \"skos:prefLabel\" : [ { \"@language\" : \"fr\" , \"@value\" : \"19e (fin)\" } , { \"@language\" : \"en\" , \"@value\" : \"Second half of the 19th century\" } , { \"@language\" : \"ru\" , \"@value\" : \"Вторая половина 19-го века\" } ] } , { \"@id\" : \"http://semium.org/time/18xx_4_quarter\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/18xx_2_half\" } , \"edm:begin\" : \"Sat Jan 01 01:00:00 CET 1876\" , \"edm:end\" : \"Mon Dec 31 00:19:32 CET 1900\" , \"skos:prefLabel\" : [ { \"@language\" : \"fr\" , \"@value\" : \"4e quart 19e siècle\" } , { \"@language\" : \"en\" , \"@value\" : \"4 quarter of the 19th century\" } , { \"@language\" : \"ru\" , \"@value\" : \"4-я четверть 19-го века\" } ] } , { \"@id\" : \"http://semium.org/time/AD2xxx\" , \"@type\" : \"edm:TimeSpan\" , \"dcterms:isPartOf\" : {\"@id\" : \"http://semium.org/time/ChronologicalPeriod\" } , \"skos:prefLabel\" : [ { \"@language\" : \"fr\" , \"@value\" : \"2e millénaire après J.-C.\" } , { \"@language\" : \"en\" , \"@value\" : \"Second millenium AD, years 1001-2000\" } , { \"@language\" : \"en\" , \"@value\" : \"Second millenium AD\" } ] } , { \"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/500,/0/default.jpg\" , \"@type\" : \"edm:WebResource\" } , { \"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/512,/0/default.jpg\" , \"@type\" : \"edm:WebResource\" , \"dcterms:isReferencedBy\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/info.json\" } , \"http://rdfs.org/sioc/services#has_service\" : {\"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454\" } } , { \"@id\" : \"https://iiif.wellcomecollection.org/image/V0038454.jpg/full/full/0/default.jpg\" , \"@type\" : \"edm:WebResource\" , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#fileByteSize\" : { \"@type\" : \"http://www.w3.org/2001/XMLSchema#long\" , \"@value\" : \"2239568\" } , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#hasMimeType\" : \"image/gif\" , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#height\" : 2536 , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#orientation\" : \"landscape\" , \"http://www.ebu.ch/metadata/ontologies/ebucore/ebucore#width\" : 3012 , \"edm:componentColor\" : [ { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#F5DEB3\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#D2B48C\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#D3D3D3\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#BDB76B\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#BC8F8F\" } , { \"@type\" : \"http://www.w3.org/2001/XMLSchema#hexBinary\" , \"@value\" : \"#C0C0C0\" } ] , \"edm:hasColorSpace\" : \"sRGB\" } , { \"@id\" : \"https://wellcomecollection.org/works/zup9etsy\" , \"@type\" : \"edm:WebResource\" } ] }");

	@Mock
	private EuropeanaSearchService europeanaSearchService;

	private RecordDataCache recordDataCache = new RecordDataCache();

	@InjectMocks
	private EuropeanaSearchResultProcessor europeanaSearchResultProcessor = new EuropeanaSearchResultProcessor(europeanaSearchService, recordDataCache);

	private void setupWithIiif() {
		when(europeanaSearchService.retrieveRecordAndConvertToJsonLd(anyString())).thenReturn(europeanaRestResponseIiif);
	}

	private void setupNoIiif() {
		when(europeanaSearchService.retrieveRecordAndConvertToJsonLd(anyString())).thenReturn(europeanaRestResponseNoIiif);
	}

	private void setupNoIiifWrongMimeType() {
		when(europeanaSearchService.retrieveRecordAndConvertToJsonLd(anyString())).thenReturn(europeanaRestResponseNoIiifWrongMimeType);
	}

	private void setupServiceUnavailable() {
		when(europeanaSearchService.retrieveRecordAndConvertToJsonLd(anyString())).thenThrow(new RuntimeException());
	}

	private SearchResult getSearchResult () {
		SearchResult searchResult = new SearchResult();
		searchResult.setId("1");
		searchResult.setTitle("test");
		return searchResult;
	}

	@Test
	public void fillMimeTypeAndVerifyAsIiif() {
		setupWithIiif();
		SearchResult searchResult = getSearchResult();
		SearchResult result = europeanaSearchResultProcessor.fillMissingDataAndValidate(searchResult, false);

		Assert.assertEquals(searchResult, result);
		Assert.assertEquals("image/jpeg", result.getFormat());
		Assert.assertEquals(IiifAvailability.AVAILABLE, result.getIiifAvailability());
	}

	@Test
	public void fillMimeTypeAndVerifyAsIiifOnlyIiif() {
		setupWithIiif();
		SearchResult searchResult = getSearchResult();
		SearchResult result = europeanaSearchResultProcessor.fillMissingDataAndValidate(searchResult, true);

		Assert.assertEquals(searchResult, result);
		Assert.assertEquals("image/jpeg", result.getFormat());
		Assert.assertEquals(IiifAvailability.AVAILABLE, result.getIiifAvailability());
	}

	@Test
	public void fillMimeTypeAndVerifyServiceUnavailable() {
		setupServiceUnavailable();
		SearchResult searchResult = getSearchResult();
		SearchResult result = europeanaSearchResultProcessor.fillMissingDataAndValidate(searchResult, false);

		Assert.assertEquals(searchResult, result);
		Assert.assertEquals("Data unavailable", result.getFormat());
		Assert.assertEquals(IiifAvailability.DATA_UNAVAILABLE, result.getIiifAvailability());
	}

	@Test
	public void fillMimeTypeAndVerifyServiceUnavailableOnlyIiif() {
		setupServiceUnavailable();
		SearchResult searchResult = getSearchResult();
		SearchResult result = europeanaSearchResultProcessor.fillMissingDataAndValidate(searchResult, true);

		Assert.assertEquals(searchResult, result);
		Assert.assertEquals("Data unavailable", result.getFormat());
		Assert.assertEquals(IiifAvailability.AVAILABLE, result.getIiifAvailability());
	}

	@Test
	public void fillMimeTypeAndVerifyAsPossibleToConvert() {
		setupNoIiif();
		SearchResult searchResult = getSearchResult();
		SearchResult result = europeanaSearchResultProcessor.fillMissingDataAndValidate(searchResult, false);

		Assert.assertEquals(searchResult, result);
		Assert.assertEquals("image/jpeg", result.getFormat());
		Assert.assertEquals(IiifAvailability.CONVERSION_POSSIBLE, result.getIiifAvailability());
	}

	@Test
	public void fillMimeTypeAndVerifyAsNotPossible() {
		setupNoIiifWrongMimeType();
		SearchResult searchResult = getSearchResult();
		SearchResult result = europeanaSearchResultProcessor.fillMissingDataAndValidate(searchResult, false);

		Assert.assertEquals(searchResult, result);
		Assert.assertEquals("image/gif", result.getFormat());
		Assert.assertEquals(IiifAvailability.CONVERSION_IMPOSSIBLE, result.getIiifAvailability());
	}

	@Test
	public void fillDataFromCache() {
		setupWithIiif();
		SearchResult searchResult = getSearchResult();
		recordDataCache.addValidationResult(searchResult.getId(), "image/jpeg", IiifAvailability.AVAILABLE);
		SearchResult result = europeanaSearchResultProcessor.fillMissingDataAndValidate(searchResult, false);

		verifyZeroInteractions(europeanaSearchService);
		Assert.assertEquals(searchResult, result);
		Assert.assertEquals("image/jpeg", result.getFormat());
		Assert.assertEquals(IiifAvailability.AVAILABLE, result.getIiifAvailability());
	}
}
